# Тестовое задания для компании "Протей"
## Осенний поток, 2023

### Текст задания:
Написать **центр обработки вызовов**, который будет принимать http-запрос с номером телефона и обрабатывать его. Для каждого поступающего звонка должен формироваться **CDR**, который содержит следующие поля:
1. DT поступления вызова,
1. Идентификатор входящего вызова (Call ID),
1. Номер абонента А,
1. DT завершения вызова,
1. Статус вызова (OK или причина ошибки, например *timeout*),
1. DT ответа оператора (если был или пустое значение),
1. Идентификатор оператора (пустое значение если соединение не состоялось),
1. Длительность разговора (пустое значение если соединение не состоялось);

---

**Каждый** телефонный звонок должен попадать в очередь, за исключечнием следующих ситуаций:
- Номер уже находится в очереди (на клиент возвращается response cо статусом *duplicated call*),
- Очередь переполнена (на клиент возвращается response с соответствующим статусом);

Во всех остальных случаях клиенту возвращается response с его **CallId**.

---

Приложение эмулирует ответ оператора или отбой через рандомное время в диапазоне **Rmin-Rmax**. То есть, запросы из очереди постоянно выбираются и приложение пытается либо “распределить” вызов на свободного оператора, либо, если все операторы заняты, -- удерживать заявку в очереди в указанном диапазоне времени **Rmin-Rmax**.

---

Эмуляция распределения заключается в том, что оператор на случайное время (длительность такого занятия также нужно настраивать в конфигурации) переходит в состояние “*Занят*”. После завершения “общения”, оператор снова становится свободным и может быть использован для обработки новой заявки из очереди. Если заявка на вызов так и не была обслужена за интервал **Rmin-Rmax**, вызов завершается отбоем с указанием причины (*timeout*).

---

**Файл конфигурации** содержит следующие параметры:
- `queue_length` -- максимальная длина очереди,
- `expire_random_min` -- минимальное время ожидание звонка в очереди,
- `expire_random_max` -- максимальное время ожидания звонка в очереди, 
- `operators_count` -- число операторов, 
- `next_update_time` -- через какое время (в секундах) произвести следующее обновление конфигурации,
- `cdr_file` -- название файла, куда будут записываться CDR'ы (опционально);

---

## Как запустить само приложение и тесты к нему?
### Сборка:

---

После `git clone` перейти в **основную** директорию проекта и выполнить следующие команды:
1. `conan install . --output-folder=build --build=missing` -- чтобы *conan* нашел и подключил или предварительно установил нужные зависимости.
   - Если на вашем компьютере нет *conan*, его следует предварительно установить с помощью команды `pip install conan`
1. `cd build/` -- спускаемся в директорию с билдом.
1. `cmake .. -DCMAKE_TOOLCHAIN_FILE=conan_toolchain.cmake -DCMAKE_BUILD_TYPE=Release` -- собираем проект с инструментарием **CMake**, указанным в *conanfile.txt*.
1. `cmake --build .` -- непосредственно собираем цели **CallCenter** & **Tests**

---

### Запуск

---

В той же директории *build/* будут собраны два ранее освещаемых исполняемых файла.
- Команда для запуска тестов -- `./Tests`
- Команда для запуска приложения -- `./CallCenter`, при этом нужно передать также следующие аргументы командной строки:
  - **Относительный путь к файлу конфигурации** от папки *include/*, т. е. путь к файлу **config.json** в корневой директории проекта выглядит как *../config.json*,
  - **Порт**, на котором будет работать приложение (**опционально**, по умолчанию будет слушаться порт **8080**);

  Пример запуска -- `./CallCenter ../config.json`
